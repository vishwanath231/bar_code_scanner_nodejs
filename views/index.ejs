<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Code Scanner App</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/html5-qrcode.min.js"></script>
</head>
<body data-rsssl=1>
    
    <main>
        <div id="reader"></div>
        <div id="result"></div>
        <div id="view_result">
        </div>
    </main>


    <script>


        document.getElementById('view_result').classList.remove('active');

        const scanner = new Html5QrcodeScanner('reader', {
            qrbox: {
                width: 250,
                height: 250,
            },
            fps: 20,
        });

        scanner.render(success, error);

        async function success(result) {

            const endpoint = window.location.origin

            document.getElementById('view_result').classList.add('active');
            document.getElementById('view_result').innerHTML = `
            <div class='result_btns'>
                <div>Loading...</div>
            </div>
            `;

            fetch(`${endpoint}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    barcode: result
                })
            })
            .then((res) => res.json())
            .then((data) => {
                if(data.length > 0){

                    document.getElementById('view_result').innerHTML = `
                        <div class='result_btns'>
                            <button class='redirect_domo' onclick="redirectdashboard('${data[0]['Style']}')">View Result</button>
                            <button class='redirect_scan' onclick="restartScan()">Scan</button>
                        </div>
                    `;
                }else{
                    document.getElementById('view_result').innerHTML = `
                    <div class='result_btns'>
                        <div>No Found Style Code</div>
                        <button class='redirect_scan' onclick="restartScan()">Scan</button>
                    </div>
                    `;
                }
            })
            .catch((err) => {
                console.error('Error:', err);
            });


            scanner.clear();
        }

        function error(err) {
            console.error(err);
        }

        function redirectdashboard(code) {
            window.open(`https://stylemail-in.domo.com/page/1629576588?pfilters=[{"column": "Style combined flow", "dataSourceId": "3d22e492-dc00-460e-8633-2ab4e5050573", "operand": "IN", "values": ["${code}"] }]`, '_blank')
        }

        function restartScan() {
            location.reload(true);
        }

    </script>
    
</body>
</html>